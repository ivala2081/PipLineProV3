# Scheduled Jobs - Automated maintenance tasks
name: Scheduled Maintenance

on:
  schedule:
    # Run database backup daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Run dependency updates weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Database Backup
  database-backup:
    name: Database Backup
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Backup Database via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            docker-compose exec -T postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > backups/$BACKUP_FILE
            gzip backups/$BACKUP_FILE
            # Keep only last 30 days of backups
            find backups/ -name "backup_*.sql.gz" -mtime +30 -delete
      
      - name: Upload backup to S3 (optional)
        if: false  # Enable if using S3
        run: |
          aws s3 cp backups/ s3://${{ secrets.S3_BUCKET }}/backups/ --recursive
      
      - name: Notify backup status
        if: always()
        run: |
          echo "Database backup ${{ job.status }}"
  
  # Dependency Updates Check
  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python dependencies
        run: |
          pip install pip-audit pip-check-updates
          pip list --outdated > python-outdated.txt
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check Node dependencies
        working-directory: ./frontend
        run: |
          npm outdated > npm-outdated.txt || true
      
      - name: Create Issue for Updates
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'Weekly Dependency Update Report'
          content-filepath: python-outdated.txt
          labels: dependencies, maintenance
  
  # Clean up old artifacts
  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10

